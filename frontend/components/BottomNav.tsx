import React from 'react';
import { View, StyleSheet, TouchableOpacity, Text, Platform } from 'react-native';
import { useRouter, usePathname } from 'expo-router';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import Svg, { Path } from 'react-native-svg';
import { colors } from '../theme/colors';

// Icon Components
const JournalIcon = ({ size = 24, color = colors.textMuted, active = false }: { size?: number; color?: string; active?: boolean }) => (
  <Svg width={size} height={size} viewBox="0 0 39 39" fill="none">
    <Path
      d="M23.9302 1H6.95809C5.37815 1.00294 3.86432 1.6305 2.7475 2.74744C1.63069 3.86438 1.00296 5.37818 1.00002 6.95793V34.745C1.0059 35.6327 1.37186 36.4807 2.01412 37.0936C2.65638 37.7064 3.51911 38.0327 4.40683 37.9974H24.1805C26.6394 37.993 28.6293 36.0016 28.6338 33.5443V5.70261C28.6294 3.10716 26.5258 1.00452 23.9302 1ZM26.7521 33.5446C26.7492 34.9643 25.5998 36.1136 24.1801 36.1166H4.40642C3.69068 36.1445 3.05723 35.6565 2.90143 34.9585C2.8882 34.8835 2.88232 34.8085 2.88085 34.7321V34.6866V34.688C2.89555 33.9253 3.5187 33.3154 4.28151 33.3154H24.1801C25.1016 33.3168 26.0011 33.0302 26.7521 32.4953L26.7521 33.5446ZM26.7521 28.8638C26.7492 30.2821 25.5998 31.4328 24.1801 31.4343H4.2815C3.79648 31.4343 3.31884 31.5416 2.88085 31.7488V6.95809C2.88379 4.708 4.70772 2.88418 6.95787 2.88117H23.93C25.4879 2.88411 26.7489 4.14658 26.7519 5.70296L26.7521 28.8638Z"
      fill={active ? colors.primary : color}
    />
    <Path
      d="M20.5854 7.06233H9.04664C7.83558 7.06527 6.85384 8.04702 6.85237 9.25802V14.6503C6.85384 15.8613 7.83562 16.843 9.04664 16.8445H20.5854C21.7965 16.843 22.7782 15.8613 22.7797 14.6503V9.25802C22.7782 8.04551 21.7964 7.06379 20.5854 7.06233ZM20.8985 14.6458C20.8985 14.7296 20.8661 14.8089 20.8073 14.8677C20.7485 14.9265 20.6692 14.9603 20.5854 14.9603H9.04664C8.87469 14.9588 8.7336 14.8192 8.7336 14.6458V9.25354C8.7336 9.08011 8.87469 8.94049 9.04664 8.94049H20.5854C20.6692 8.94049 20.7485 8.97283 20.8073 9.03162C20.8661 9.0904 20.8985 9.17123 20.8985 9.25354V14.6458Z"
      fill={active ? colors.primary : color}
    />
    <Path
      d="M34.2375 1C32.1608 1 30.4751 2.68427 30.4751 4.76238V31.1871C30.4765 31.8984 30.6382 32.6009 30.9468 33.2432L32.9163 37.2802C33.2043 37.7285 33.7011 38.0004 34.2346 37.9989C34.8063 37.993 35.3325 37.6815 35.6132 37.1832L37.5268 33.2429H37.5282C37.8369 32.6006 37.9986 31.8981 38 31.1868V4.76058C37.9986 2.68393 36.3142 1.00147 34.2375 1ZM32.3563 28.8638V7.56348H36.1188V28.8638H32.3563ZM34.2375 2.88119C35.2766 2.88119 36.1188 3.72333 36.1188 4.76238V5.68387H32.3563V4.76092C32.3578 3.72186 33.1999 2.88119 34.2375 2.88119ZM34.2375 35.708L32.3563 31.1871H36.1188L34.2375 35.708Z"
      fill={active ? colors.primary : color}
    />
  </Svg>
);

const HabitsIcon = ({ size = 24, color = colors.textMuted, active = false }: { size?: number; color?: string; active?: boolean }) => (
  <Svg width={size} height={size} viewBox="0 0 39 39" fill="none">
    <Path
      d="M18.4146 22.6379C18.3574 21.5313 17.4688 20.6426 16.3621 20.5855L16.25 20.5834H2.16667C0.969096 20.5834 0 21.5525 0 22.75V36.8333C0 38.0309 0.969096 39 2.16667 39H16.25L16.3621 38.9979C17.4688 38.9408 18.3574 38.0521 18.4146 36.9455L18.4167 36.8333V22.75L18.4146 22.6379ZM12.4584 29.7917C12.4584 27.9974 11.0027 26.5417 9.20841 26.5417C7.41414 26.5417 5.95841 27.9974 5.95841 29.7917C5.95841 31.586 7.41414 33.0417 9.20841 33.0417C11.0027 33.0417 12.4584 31.586 12.4584 29.7917ZM28.5199 25.4182C29.398 24.0682 31.4271 24.1148 32.227 25.5536L35.8028 31.9902L35.8727 32.1256C36.518 33.4967 35.5743 35.1006 34.0614 35.2021L33.9091 35.2085H26.7575C25.105 35.2085 24.0618 33.4333 24.8638 31.9902L28.4396 25.5536L28.5199 25.4182ZM26.7574 33.0416H33.909L30.3331 26.605L26.7574 33.0416ZM23.2895 7.47119C23.2323 6.36457 22.3437 5.47591 21.237 5.41877L21.1249 5.41665H17.8749C16.6773 5.41665 15.7082 6.38575 15.7082 7.58331V10.8333L15.7103 10.9454C15.7696 12.0901 16.7154 13 17.8749 13H21.1249L21.237 12.9979C22.3437 12.9407 23.2323 12.0521 23.2895 10.9454L23.2916 10.8333V7.58331L23.2895 7.47119ZM14.625 29.7916C14.625 32.7834 12.2001 35.2082 9.2083 35.2082C6.21646 35.2082 3.79163 32.7834 3.79163 29.7916C3.79163 26.7998 6.21646 24.3749 9.2083 24.3749C12.2001 24.3749 14.625 26.7998 14.625 29.7916ZM20.5833 36.8332L20.5854 36.9454C20.6447 38.0901 21.5905 38.9999 22.75 38.9999H36.8333L36.9455 38.9978C38.0521 38.9407 38.9407 38.052 38.9979 36.9454L39 36.8332V22.7499C39 21.5904 38.0902 20.6446 36.9455 20.5854L36.8333 20.5833H22.75C21.5905 20.5833 20.6447 21.4931 20.5854 22.6378L20.5833 22.75L20.5833 36.8332ZM28.7061 2.05454C28.649 0.947918 27.7603 0.0592616 26.6537 0.00211588L26.5416 0H12.4582C11.2607 0 10.2916 0.969093 10.2916 2.16666V16.25L10.2937 16.3621C10.3529 17.5068 11.2987 18.4166 12.4582 18.4166H26.5416C27.7011 18.4166 28.6469 17.5068 28.7061 16.3621L28.7082 16.25V2.16666L28.7061 2.05454ZM25.4583 10.8333L25.4519 11.0555C25.3398 13.2729 23.5645 15.0481 21.3471 15.1603L21.1249 15.1666H17.8749C15.5559 15.1666 13.6643 13.3469 13.5479 11.0555L13.5416 10.8333V7.58333C13.5416 5.19025 15.4818 3.25 17.8749 3.25H21.1249L21.3471 3.25635C23.6386 3.37272 25.4582 5.26431 25.4582 7.58334L25.4583 10.8333Z"
      fill={active ? colors.primary : color}
    />
  </Svg>
);

const PlusIcon = ({ size = 34, color = '#FFFFFF' }: { size?: number; color?: string }) => (
  <Svg width={size} height={size} viewBox="0 0 68 68" fill="none">
    <Path
      fillRule="evenodd"
      clipRule="evenodd"
      d="M34 0C52.7771 0 68 15.2229 68 34C68 52.7771 52.7771 68 34 68C15.2229 68 0 52.7771 0 34C0 15.2229 15.2229 0 34 0ZM34 13.4376C31.574 13.4405 29.5936 15.3441 29.4726 17.7377L29.4667 17.9709V29.4667H17.9709L17.7377 29.4726C15.3441 29.5936 13.4376 31.5739 13.4376 34C13.4376 36.4261 15.3441 38.4064 17.7377 38.5274L17.9709 38.5333H29.4667V50.0291L29.4726 50.2623C29.5936 52.6559 31.5739 54.5595 34 54.5624C36.426 54.5595 38.4064 52.6559 38.5274 50.2623L38.5333 50.0291V38.5333H50.0291L50.2623 38.5274C52.6559 38.4064 54.5624 36.4261 54.5624 34C54.5624 31.5739 52.6559 29.5936 50.2623 29.4726L50.0291 29.4667H38.5333V17.9709L38.5274 17.7377C38.4064 15.3441 36.4261 13.4405 34 13.4376Z"
      fill={color}
    />
  </Svg>
);

const GoalsIcon = ({ size = 24, color = colors.textMuted, active = false }: { size?: number; color?: string; active?: boolean }) => (
  <Svg width={size} height={size} viewBox="0 0 39 38" fill="none">
    <Path
      d="M8.93716 37.9872C8.2606 37.9755 7.61734 37.683 7.15978 37.1759C6.70029 36.6708 6.46566 35.9961 6.50671 35.3096L7.15978 24.8235L0.568471 16.7188V16.7169C0.0268704 16.0499 -0.141316 15.147 0.122662 14.324C0.388582 13.503 1.04949 12.8751 1.87265 12.6644L11.8602 10.0551L17.4174 1.17207V1.17012C17.871 0.440781 18.661 0 19.5096 0C20.3582 0 21.1461 0.440736 21.6017 1.17012L27.1354 10.0531L37.1465 12.6625L37.1445 12.6644C37.9657 12.8809 38.6208 13.5108 38.8809 14.3318C39.1409 15.1528 38.9688 16.0538 38.4272 16.7168L31.8594 24.8215L32.489 35.3076V35.3095C32.5457 36.1696 32.1664 37.0023 31.4821 37.5113C30.7977 38.0222 29.9042 38.1412 29.1142 37.8272L19.5095 33.9581L9.90489 37.8272H9.90293C9.59399 37.9462 9.26567 38.0008 8.93716 37.9872ZM11.7039 31.6688L18.5865 28.8976C19.1712 28.6616 19.8242 28.6616 20.4088 28.8976L27.315 31.6688L26.8418 24.1352C26.8027 23.4956 27.0041 22.8656 27.4049 22.3723L32.1505 16.5571L24.953 14.6791C24.3409 14.5251 23.8111 14.1409 23.4689 13.6027L19.5094 7.23732L15.5285 13.6027H15.5265C15.1902 14.137 14.6682 14.5212 14.0659 14.6791L6.8684 16.5571L11.6139 22.3723C12.0128 22.8657 12.2142 23.4956 12.1751 24.1352L11.7019 31.6688H11.7039Z"
      fill={active ? colors.primary : color}
    />
  </Svg>
);

const MoodIcon = ({ size = 24, color = colors.textMuted, active = false }: { size?: number; color?: string; active?: boolean }) => (
  <Svg width={size} height={size} viewBox="0 0 38 38" fill="none">
    <Path
      d="M19 0C15.2422 0 11.5687 1.11433 8.44417 3.20208C5.31964 5.28982 2.88436 8.25722 1.4463 11.729C0.00823234 15.2008 -0.368031 19.0211 0.365088 22.7067C1.09821 26.3923 2.90778 29.7778 5.56498 32.435C8.22218 35.0922 11.6077 36.9018 15.2933 37.6349C18.9789 38.368 22.7992 37.9918 26.271 36.5537C29.7428 35.1156 32.7102 32.6804 34.7979 29.5558C36.8857 26.4313 38 22.7578 38 19C38 13.9609 35.9982 9.12816 32.435 5.56497C28.8718 2.00178 24.0391 0 19 0ZM19 33.25C16.1816 33.25 13.4265 32.4142 11.0831 30.8484C8.73973 29.2826 6.91327 27.0571 5.83472 24.4532C4.75617 21.8494 4.47398 18.9842 5.02382 16.22C5.57366 13.4557 6.93084 10.9166 8.92373 8.92373C10.9166 6.93083 13.4557 5.57365 16.22 5.02381C18.9842 4.47397 21.8494 4.75617 24.4532 5.83472C27.0571 6.91326 29.2826 8.73972 30.8484 11.0831C32.4143 13.4265 33.25 16.1816 33.25 19C33.25 22.7793 31.7487 26.4039 29.0763 29.0763C26.4039 31.7487 22.7793 33.25 19 33.25Z"
      fill={active ? colors.primary : color}
    />
    <Path
      d="M21.5353 22.1469C21.2039 22.4826 20.8092 22.7491 20.374 22.931C19.9387 23.113 19.4717 23.2066 19 23.2066C18.5283 23.2066 18.0613 23.113 17.6261 22.931C17.1908 22.7491 16.7961 22.4826 16.4647 22.1469C16.2464 21.9235 15.9862 21.7453 15.699 21.6224C15.4118 21.4996 15.1032 21.4345 14.7909 21.4309C14.4786 21.4274 14.1686 21.4853 13.8786 21.6015C13.5887 21.7178 13.3245 21.8899 13.1011 22.1083C12.8777 22.3266 12.6995 22.5868 12.5767 22.874C12.4538 23.1612 12.3888 23.4697 12.3852 23.7821C12.3816 24.0944 12.4396 24.4044 12.5558 24.6943C12.672 24.9843 12.8442 25.2485 13.0625 25.4719C13.8365 26.2618 14.7603 26.8893 15.7798 27.3177C16.7994 27.7462 17.8941 27.9668 19 27.9668C20.1059 27.9668 21.2007 27.7462 22.2202 27.3177C23.2397 26.8893 24.1636 26.2618 24.9375 25.4719C25.1645 25.2511 25.3451 24.9872 25.4686 24.6957C25.5921 24.4041 25.6561 24.0909 25.6567 23.7742C25.6574 23.4576 25.5948 23.144 25.4725 22.852C25.3502 22.5599 25.1708 22.2953 24.9447 22.0736C24.7187 21.8519 24.4506 21.6776 24.1562 21.561C23.8618 21.4445 23.5471 21.3879 23.2305 21.3948C22.914 21.4016 22.602 21.4716 22.3129 21.6008C22.0238 21.73 21.7635 21.9156 21.5472 22.1469H21.5353Z"
      fill={active ? colors.primary : color}
    />
    <Path
      d="M13.8166 17.7531C15.1282 17.7531 16.1916 16.6898 16.1916 15.3781C16.1916 14.0664 15.1282 13.0031 13.8166 13.0031C12.5049 13.0031 11.4416 14.0664 11.4416 15.3781C11.4416 16.6898 12.5049 17.7531 13.8166 17.7531Z"
      fill={active ? colors.primary : color}
    />
    <Path
      d="M24.5041 17.7531C25.8157 17.7531 26.8791 16.6898 26.8791 15.3781C26.8791 14.0664 25.8157 13.0031 24.5041 13.0031C23.1924 13.0031 22.1291 14.0664 22.1291 15.3781C22.1291 16.6898 23.1924 17.7531 24.5041 17.7531Z"
      fill={active ? colors.primary : color}
    />
  </Svg>
);

const HomeIcon = ({ size = 24, color = colors.textMuted, active = false }: { size?: number; color?: string; active?: boolean }) => (
  <Svg width={size} height={size * 0.833} viewBox="0 0 48 40" fill="none">
    <Path
      d="M44.7031 17.1483L24.9212 1.97396C24.5109 1.66628 24.0121 1.5 23.4996 1.5C22.987 1.5 22.4883 1.66628 22.0779 1.97396L2.29609 17.1483C1.93677 17.4089 1.67833 17.7858 1.56448 18.2153C1.45063 18.6447 1.48836 19.1004 1.67129 19.5053C1.85424 19.8903 2.14521 20.2137 2.50864 20.4358C2.87206 20.658 3.29221 20.7692 3.71774 20.756H8.94957V35.1281C8.94957 36.9877 10.6469 38.5 12.7326 38.5H34.2686C36.3543 38.5 38.0516 36.9882 38.0516 35.1281V20.756H43.2834C43.7092 20.7691 44.1295 20.6575 44.4929 20.435C44.8564 20.2125 45.1472 19.8887 45.3299 19.5032C45.5121 19.0984 45.5492 18.643 45.435 18.214C45.3208 17.7849 45.0623 17.4085 44.7031 17.1483ZM25.9299 36.4338H21.0693V26.4839H25.9299V36.4338ZM43.2834 18.6899H37.0203C36.8849 18.6898 36.7507 18.7165 36.6255 18.7684C36.5004 18.8202 36.3866 18.8963 36.2908 18.9923C36.195 19.0882 36.119 19.2021 36.0671 19.3275C36.0153 19.4529 35.9886 19.5872 35.9886 19.723V35.1281C35.9886 35.8361 35.2013 36.4338 34.2686 36.4338H27.9924V25.4508C27.9924 25.1768 27.8838 24.914 27.6904 24.7203C27.497 24.5266 27.2347 24.4177 26.9611 24.4177H20.038C19.7645 24.4177 19.5022 24.5266 19.3088 24.7203C19.1154 24.914 19.0068 25.1768 19.0068 25.4508V36.4338H12.7306C11.7979 36.4338 11.0101 35.8361 11.0101 35.1281V19.725C11.0101 19.451 10.9015 19.1882 10.7081 18.9945C10.5146 18.8007 10.2523 18.6919 9.97883 18.6919L6.78214 18.3822C6.78214 18.3822 6.78214 18.2153 4.51836 18.2153L23.3321 3.61481C23.3823 3.58346 23.4404 3.56684 23.4996 3.56684C23.5588 3.56684 23.6168 3.58346 23.6671 3.61481L41.2418 17.1483C41.23 17.1483 41.2438 17.1483 43.2834 18.6899Z"
      fill={active ? colors.primary : color}
      stroke={active ? colors.primary : color}
      strokeWidth="3"
    />
  </Svg>
);

interface NavItem {
  label: string;
  route: string;
  icon: React.ComponentType<{ size?: number; color?: string; active?: boolean }>;
}

const navItemsBeforePlus: NavItem[] = [
  { label: 'Home', route: '/', icon: HomeIcon },
  { label: 'Journal', route: '/journal', icon: JournalIcon },
];

const navItemsAfterPlus: NavItem[] = [
  { label: 'Habits', route: '/habits', icon: HabitsIcon },
  { label: 'Mood', route: '/mood', icon: MoodIcon },
];

export default function BottomNav() {
  const router = useRouter();
  const pathname = usePathname();
  const insets = useSafeAreaInsets();

  // Don't show on login/register screens
  const hideNavRoutes = ['/login', '/register', '/auth/login', '/auth/register'];
  const shouldHide = hideNavRoutes.some(route => pathname?.startsWith(route));

  if (shouldHide) {
    return null;
  }

  const handlePlusPress = () => {
    // Determine which screen to navigate to based on current route
    if (pathname?.startsWith('/habits')) {
      router.push('/habits/new');
    } else if (pathname?.startsWith('/journal')) {
      router.push('/journal/new');
    } else if (pathname?.startsWith('/mood')) {
      router.push('/mood/new');
    } else {
      // Default to new habit
      router.push('/habits/new');
    }
  };

  const isActive = (route: string) => {
    if (!pathname) return false;
    const normalizedPath = pathname.replace(/\/$/, ''); // Remove trailing slash
    const normalizedRoute = route.replace(/\/$/, '');
    
    // Home route (/) should be active only on exact match or index
    if (normalizedRoute === '/' || normalizedRoute === '') {
      return normalizedPath === '' || normalizedPath === '/';
    }
    
    if (normalizedRoute === '/habits') {
      return normalizedPath.startsWith('/habits') && !normalizedPath.includes('/new');
    }
    
    return normalizedPath === normalizedRoute || normalizedPath.startsWith(normalizedRoute + '/');
  };

  const renderNavItem = (item: NavItem) => {
    const active = isActive(item.route);
    const Icon = item.icon;
    return (
      <TouchableOpacity
        key={item.route}
        style={styles.navItem}
        onPress={() => router.push(item.route)}
        activeOpacity={0.7}
      >
        <Icon size={24} active={active} color={active ? colors.primary : colors.textMuted} />
        <Text style={[styles.label, active && styles.labelActive]}>
          {item.label}
        </Text>
      </TouchableOpacity>
    );
  };

  return (
    <View style={[styles.container, { paddingBottom: Math.max(insets.bottom, 8) }]}>
      <View style={styles.navBar}>
        {/* Items before plus button */}
        {navItemsBeforePlus.map(renderNavItem)}
        
        {/* Central Plus Button */}
        <TouchableOpacity
          style={styles.plusButton}
          onPress={handlePlusPress}
          activeOpacity={0.8}
        >
          <PlusIcon size={34} />
        </TouchableOpacity>
        
        {/* Items after plus button */}
        {navItemsAfterPlus.map(renderNavItem)}
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    position: 'absolute',
    bottom: 0,
    left: 0,
    right: 0,
    backgroundColor: 'transparent',
    paddingHorizontal: 16,
    paddingTop: 8,
  },
  navBar: {
    flexDirection: 'row',
    backgroundColor: colors.surface,
    borderRadius: 24,
    borderWidth: 1,
    borderColor: colors.border,
    paddingVertical: 12,
    paddingHorizontal: 8,
    alignItems: 'center',
    justifyContent: 'space-around',
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: -2,
    },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 8,
  },
  navItem: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 4,
  },
  label: {
    fontSize: 11,
    fontWeight: '600',
    color: colors.textMuted,
    marginTop: 4,
  },
  labelActive: {
    color: colors.primary,
  },
  plusButton: {
    width: 56,
    height: 56,
    borderRadius: 28,
    backgroundColor: colors.textMain,
    alignItems: 'center',
    justifyContent: 'center',
    marginHorizontal: 8,
    marginTop: -20, // Raise it above the nav bar
    shadowColor: '#000',
    shadowOffset: {
      width: 0,
      height: 4,
    },
    shadowOpacity: 0.3,
    shadowRadius: 8,
    elevation: 8,
  },
});
